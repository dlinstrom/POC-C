<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Water Level Monitor - 3 Sensors</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{
  font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;
  background: linear-gradient(135deg,#2d5016 0%,#68a225 100%);
  min-height:100vh;
  padding:10px;
  -webkit-text-size-adjust:100%;
  -webkit-font-smoothing:antialiased;
}
@media (min-width:768px){ body{padding:20px;} }

.container{
  background:rgba(255,255,255,0.95);
  border-radius:15px;
  box-shadow:0 10px 30px rgba(0,0,0,0.30);
  padding:15px;
  max-width:1400px;
  margin:0 auto;
}
@media (min-width:768px){
  .container{border-radius:20px;padding:30px;}
}

h1{color:#333;text-align:center;margin-bottom:15px;font-size:1.8em;line-height:1.2;}
@media (min-width:768px){ h1{font-size:2.2em;margin-bottom:20px;} }

.status{
  text-align:center;padding:12px;border-radius:10px;margin-bottom:15px;
  font-weight:600;font-size:14px;
}
@media (min-width:768px){ .status{padding:10px;margin-bottom:20px;font-size:16px;} }

.loading-notice,.info-notice,.error-notice{
  padding:12px;border-radius:10px;margin-bottom:15px;text-align:center;font-size:14px;
}
@media (min-width:768px){
  .loading-notice,.info-notice,.error-notice{padding:15px;margin-bottom:20px;font-size:16px;}
}
.loading-notice{background:#d1ecf1;color:#0c5460;}
.info-notice{background:#cce5ff;color:#004085;}
.error-notice{background:#f8d7da;color:#721c24;display:none;}

.status.connected{background:#d4f4dd;color:#2d5016;}
.status.disconnected{background:#f8d7da;color:#721c24;}
.status.connecting{background:#fff3cd;color:#856404;}

.config-section{background:#f8f9fa;border-radius:10px;padding:15px;margin-bottom:15px;}
@media (min-width:768px){ .config-section{padding:20px;margin-bottom:20px;} }
.config-section h3{margin-bottom:12px;color:#333;font-size:1.1em;}
@media (min-width:768px){ .config-section h3{margin-bottom:15px;font-size:1.2em;} }

.config-grid{
  display:grid;grid-template-columns:1fr;gap:8px;margin-bottom:12px;
}
@media (min-width:480px){ .config-grid{grid-template-columns:repeat(2,1fr);gap:10px;} }
@media (min-width:768px){ .config-grid{grid-template-columns:repeat(auto-fit,minmax(200px,1fr));margin-bottom:15px;} }

input,select{
  width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:16px;
  -webkit-appearance:none;appearance:none;
}
@media (min-width:768px){ input,select{padding:10px;border-radius:5px;font-size:14px;} }
input:focus,select:focus{
  outline:none;border-color:#4a7c28;box-shadow:0 0 0 3px rgba(74,124,40,0.10);
}

.button-group{display:flex;gap:8px;flex-wrap:wrap;}
@media (min-width:768px){ .button-group{gap:10px;} }

button{
  background:linear-gradient(135deg,#4a7c28 0%,#68a225 100%);
  color:white;border:none;padding:12px 16px;border-radius:8px;font-size:14px;font-weight:600;
  cursor:pointer;transition:transform 0.2s;min-height:44px;flex:1;min-width:120px;
}
@media (min-width:768px){ button{padding:10px 20px;border-radius:5px;min-height:auto;flex:initial;min-width:auto;} }
button:hover:not(:disabled){transform:scale(1.02);}
@media (min-width:768px){ button:hover:not(:disabled){transform:scale(1.05);} }
button:active{transform:scale(0.98);}
button:disabled{opacity:0.5;cursor:not-allowed;}

.preset-btn{background:white;color:#4a7c28;border:2px solid #4a7c28;}
.preset-btn:hover{background:#4a7c28;color:white;}
.export-btn{background:linear-gradient(135deg,#2d5016 0%,#5cb85c 100%);}
.clear-btn{background:linear-gradient(135deg,#8b6f47 0%,#b8a074 100%);}

.stats-grid{display:grid;grid-template-columns:1fr;gap:10px;margin-bottom:15px;}
@media (min-width:480px){ .stats-grid{grid-template-columns:repeat(2,1fr);} }
@media (min-width:768px){ .stats-grid{grid-template-columns:repeat(3,1fr);gap:15px;margin-bottom:20px;} }

.stat-card{background:linear-gradient(135deg,#f5f7fa 0%,#c3cfe2 100%);border-radius:10px;padding:12px;text-align:center;}
@media (min-width:768px){ .stat-card{padding:15px;} }

.stat-label{font-size:0.8em;color:#666;margin-bottom:5px;line-height:1.2;}
@media (min-width:768px){ .stat-label{font-size:0.9em;} }
.stat-value{font-size:1.4em;font-weight:bold;color:#333;}
@media (min-width:768px){ .stat-value{font-size:1.8em;} }

.sensors-grid{display:grid;grid-template-columns:1fr;gap:15px;margin-bottom:15px;}
@media (min-width:768px){ .sensors-grid{grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;margin-bottom:20px;} }

.sensor-card{
  background:linear-gradient(135deg,#4a7c28 0%,#68a225 100%);
  border-radius:15px;padding:15px;color:white;box-shadow:0 8px 25px rgba(0,0,0,0.20);
}
@media (min-width:768px){ .sensor-card{padding:20px;box-shadow:0 10px 30px rgba(0,0,0,0.20);} }
.sensor-card h3{margin-bottom:12px;font-size:1.1em;}
@media (min-width:768px){ .sensor-card h3{margin-bottom:15px;font-size:1.2em;} }

.water-level-display{font-size:2em;font-weight:bold;margin:12px 0;text-align:center;line-height:1;}
@media (min-width:768px){ .water-level-display{font-size:2.5em;margin:15px 0;} }

.tank-visual{
  width:100%;height:100px;background:rgba(255,255,255,0.20);
  border-radius:8px;position:relative;overflow:hidden;margin:12px 0;
}
@media (min-width:768px){ .tank-visual{height:120px;border-radius:10px;margin:15px 0;} }

.water-fill{
  position:absolute;bottom:0;width:100%;
  background:linear-gradient(180deg,#4fc3f7 0%,#29b6f6 100%);
  transition:height 0.8s ease;
  display:flex;align-items:center;justify-content:center;
  color:white;font-weight:bold;font-size:14px;
}
.water-fill > span{display:none;}

.sensor-info{
  display:flex;justify-content:space-between;font-size:0.8em;opacity:0.9;flex-wrap:wrap;gap:8px;
}
@media (min-width:768px){ .sensor-info{font-size:0.9em;flex-wrap:nowrap;gap:0;} }

.history-section{
  background:white;border-radius:15px;padding:15px;margin-bottom:15px;
  box-shadow:0 4px 12px rgba(0,0,0,0.10);
}
@media (min-width:768px){ .history-section{padding:20px;margin-bottom:20px;box-shadow:0 5px 15px rgba(0,0,0,0.10);} }
.history-section h3{margin-bottom:12px;color:#333;font-size:1.1em;}
@media (min-width:768px){ .history-section h3{margin-bottom:15px;font-size:1.2em;} }

.history-table{
  width:100%;max-height:250px;overflow-y:auto;-webkit-overflow-scrolling:touch;
  border-radius:8px;border:1px solid #ddd;
}
@media (min-width:768px){ .history-table{max-height:300px;} }
.history-table table{width:100%;border-collapse:collapse;font-size:14px;}
@media (min-width:768px){ .history-table table{font-size:16px;} }
.history-table th{
  background:#4a7c28;color:white;padding:8px 6px;text-align:left;position:sticky;top:0;
  font-size:12px;white-space:nowrap;
}
@media (min-width:768px){ .history-table th{padding:10px;font-size:14px;} }
.history-table td{padding:6px;border-bottom:1px solid #ddd;font-size:12px;white-space:nowrap;}
@media (min-width:768px){ .history-table td{padding:8px;font-size:14px;} }

.map-container{
  background:white;border-radius:15px;padding:12px;margin-bottom:15px;
  box-shadow:0 4px 12px rgba(0,0,0,0.10);
}
@media (min-width:768px){ .map-container{padding:20px;margin-bottom:20px;box-shadow:0 5px 15px rgba(0,0,0,0.10);} }
.map-container h3{margin-bottom:12px;color:#333;font-size:1.1em;}
@media (min-width:768px){ .map-container h3{margin-bottom:15px;font-size:1.2em;} }

.message-log{
  background:#f8f9fa;border-radius:10px;padding:12px;margin-top:15px;
  max-height:150px;overflow-y:auto;-webkit-overflow-scrolling:touch;
}
@media (min-width:768px){ .message-log{padding:15px;margin-top:20px;max-height:200px;} }
.message-log h3{margin-bottom:8px;color:#333;font-size:1em;}
@media (min-width:768px){ .message-log h3{margin-bottom:10px;font-size:1.1em;} }
.log-entry{
  font-family:monospace;font-size:11px;padding:4px;border-bottom:1px solid #ddd;
  word-wrap:break-word;line-height:1.3;
}
@media (min-width:768px){ .log-entry{font-size:12px;padding:5px;} }

.footer-info{text-align:center;color:#666;font-size:0.8em;margin-top:15px;line-height:1.4;}
@media (min-width:768px){ .footer-info{font-size:0.9em;margin-top:20px;} }

/* --- Shared Chat (MQTT-backed) --- */
.chat-widget{
  position:absolute;
  right:12px;
  bottom:12px;
  width:min(360px, 92%);
  height:260px;
  z-index:50;
  display:flex;
  flex-direction:column;
  background: rgba(255,255,255,0.96);
  border: 2px solid rgba(74,124,40,0.45);
  border-radius: 14px;
  box-shadow: 0 10px 26px rgba(0,0,0,0.25);
  overflow:hidden;
  backdrop-filter: blur(6px);
}
.chat-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:8px;
  padding:10px 12px;
  background: linear-gradient(135deg, rgba(74,124,40,0.95) 0%, rgba(104,162,37,0.95) 100%);
  color:#fff;
  font-weight:700;
  font-size:13px;
}
.chat-header small{ font-weight:600; opacity:0.9; }
.chat-feed{
  flex:1;
  padding:10px 12px;
  overflow:auto;
  background: rgba(255,255,255,0.92);
}
.chat-msg{
  margin:0 0 8px 0;
  padding:8px 10px;
  border-radius: 12px;
  border: 1px solid rgba(0,0,0,0.08);
  background: rgba(245,247,250,0.95);
}
.chat-msg .meta{
  display:flex;
  gap:8px;
  align-items:baseline;
  flex-wrap:wrap;
  margin-bottom:4px;
  font-size:11px;
  color:#555;
}
.chat-msg .meta .who{ font-weight:700; color:#2d5016; }
.chat-msg .meta .kind{
  font-weight:800;
  font-size:10px;
  padding:2px 6px;
  border-radius: 999px;
  border:1px solid rgba(74,124,40,0.25);
  color:#2d5016;
  background: rgba(212,244,221,0.55);
}
.chat-msg .body{
  font-size:13px;
  color:#222;
  line-height:1.25;
  word-wrap:break-word;
}
.chat-compose{
  display:grid;
  grid-template-columns: 1fr 110px;
  gap:8px;
  padding:10px 12px;
  background: rgba(248,249,250,0.95);
  border-top:1px solid rgba(0,0,0,0.08);
}
.chat-compose input, .chat-compose select{
  padding:10px;
  border-radius:10px;
  border:1px solid rgba(0,0,0,0.18);
  font-size:13px;
}
.chat-compose .row2{
  grid-column: 1 / -1;
  display:grid;
  grid-template-columns: 1fr 110px;
  gap:8px;
}
.chat-compose button{
  min-width:110px;
  padding:10px 12px;
  border-radius:10px;
  font-size:13px;
  min-height:auto;
}
.chat-hint{
  padding:8px 12px;
  font-size:11px;
  color:#666;
  background: rgba(255,255,255,0.85);
  border-top:1px dashed rgba(0,0,0,0.12);
}
@media (max-width:480px){
  .chat-widget{ height:240px; right:10px; bottom:10px; }
}
</style>
</head>

<body>
<div class="container">
  <h1>üåä Water Level Monitor - 3 Sensors</h1>

  <div id="status" class="status disconnected">Not Connected</div>
  <div id="loadingNotice" class="loading-notice">Loading MQTT library... Please wait...</div>
  <div id="errorNotice" class="error-notice"></div>

  <div class="config-section">
    <h3>MQTT Configuration</h3>
    <div class="button-group">
      <button class="preset-btn" onclick="setPreset('emqx')">EMQX Public</button>
      <button class="preset-btn" onclick="setPreset('hivemq')">HiveMQ Public</button>
      <button class="preset-btn" onclick="setPreset('mosquitto')">Test Mosquitto (Secure)</button>
    </div>
    <br />

    <div class="config-grid">
      <input type="text" id="broker" placeholder="Broker URL" value="broker.emqx.io" />
      <input type="text" id="port" placeholder="Port" value="8084" />
      <input type="text" id="topic" placeholder="Topic" value="msh/US/2/json/#" />
      <input type="text" id="chatTopic" placeholder="Chat Topic Base" value="waterlevel/chat" />
      <select id="maxPoints">
        <option value="50">Keep last 50 readings</option>
        <option value="100" selected>Keep last 100 readings</option>
        <option value="200">Keep last 200 readings</option>
      </select>
    </div>

    <div class="button-group">
      <button id="connectBtn" onclick="connectMQTT()" disabled>Connect</button>
      <button id="disconnectBtn" onclick="disconnectMQTT()" style="display:none;">Disconnect</button>
      <button class="export-btn" onclick="exportData()">Export CSV</button>
      <button class="clear-btn" onclick="clearData()">Clear Data</button>
    </div>
  </div>

  <div class="stats-grid">
    <div class="stat-card"><div class="stat-label">Sensor 1 Current</div><div class="stat-value" id="stat1">-- ft</div></div>
    <div class="stat-card"><div class="stat-label">Sensor 2 Current</div><div class="stat-value" id="stat2">-- ft</div></div>
    <div class="stat-card"><div class="stat-label">Sensor 3 Current</div><div class="stat-value" id="stat3">-- ft</div></div>
  </div>

  <div class="stats-grid">
    <div class="stat-card"><div class="stat-label">Sensor 1 Min/Max</div><div class="stat-value" id="minmax1">-- / --</div></div>
    <div class="stat-card"><div class="stat-label">Sensor 2 Min/Max</div><div class="stat-value" id="minmax2">-- / --</div></div>
    <div class="stat-card"><div class="stat-label">Sensor 3 Min/Max</div><div class="stat-value" id="minmax3">-- / --</div></div>
  </div>

  <div class="sensors-grid">
    <div class="sensor-card">
      <h3>Water Sensor 1</h3>
      <div class="tank-visual"><div class="water-fill" id="tank1" style="height:0%"><span id="percent1">0%</span></div></div>
      <div class="water-level-display" id="level1">-- ft</div>
      <div class="sensor-info"><span>Node: <span id="node1">--</span></span><span>CPU: <span id="cpu1">--¬∞C</span></span></div>
    </div>
    <div class="sensor-card">
      <h3>Water Sensor 2</h3>
      <div class="tank-visual"><div class="water-fill" id="tank2" style="height:0%"><span id="percent2">0%</span></div></div>
      <div class="water-level-display" id="level2">-- ft</div>
      <div class="sensor-info"><span>Node: <span id="node2">--</span></span><span>CPU: <span id="cpu2">--¬∞C</span></span></div>
    </div>
    <div class="sensor-card">
      <h3>Water Sensor 3</h3>
      <div class="tank-visual"><div class="water-fill" id="tank3" style="height:0%"><span id="percent3">0%</span></div></div>
      <div class="water-level-display" id="level3">-- ft</div>
      <div class="sensor-info"><span>Node: <span id="node3">--</span></span><span>CPU: <span id="cpu3">--¬∞C</span></span></div>
    </div>
  </div>

  <div class="history-section">
    <h3>Recent Readings</h3>
    <div class="history-table">
      <table>
        <thead>
          <tr><th>Time</th><th>Sensor 1 (ft)</th><th>Sensor 2 (ft)</th><th>Sensor 3 (ft)</th></tr>
        </thead>
        <tbody id="historyTableBody">
          <tr><td colspan="4" style="text-align:center;">No data yet</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="map-container">
    <h3>üåä Sensor Locations - Morro Bay, CA</h3>

    <div style="position:relative;background:#f0f8ff;border-radius:10px;overflow:hidden;">
      <img id="morroMap" src="morro-bay-map.jpg" alt="Morro Bay Map" style="width:100%;height:auto;display:block;" />

      <!-- Overlay markers (adjust top/left % as needed) -->
      <div style="position:absolute;top:18%;left:35%;transform:translate(-50%,-50%);">
        <div style="background:white;border:3px solid #4a7c28;border-radius:50%;width:40px;height:40px;display:flex;align-items:center;justify-content:center;font-weight:bold;color:#4a7c28;box-shadow:0 2px 8px rgba(0,0,0,0.30);">1</div>
        <div style="background:white;border:2px solid #4a7c28;border-radius:5px;padding:5px;margin-top:5px;text-align:center;font-size:12px;font-weight:bold;color:#2d5016;box-shadow:0 2px 8px rgba(0,0,0,0.30);">
          <span id="overlay-level-1">-- ft</span>
        </div>
      </div>

      <div style="position:absolute;top:52%;left:48%;transform:translate(-50%,-50%);">
        <div style="background:white;border:3px solid #4a7c28;border-radius:50%;width:40px;height:40px;display:flex;align-items:center;justify-content:center;font-weight:bold;color:#4a7c28;box-shadow:0 2px 8px rgba(0,0,0,0.30);">2</div>
        <div style="background:white;border:2px solid #4a7c28;border-radius:5px;padding:5px;margin-top:5px;text-align:center;font-size:12px;font-weight:bold;color:#2d5016;box-shadow:0 2px 8px rgba(0,0,0,0.30);">
          <span id="overlay-level-2">-- ft</span>
        </div>
      </div>

      <div style="position:absolute;top:85%;left:48%;transform:translate(-50%,-50%);">
        <div style="background:white;border:3px solid #4a7c28;border-radius:50%;width:40px;height:40px;display:flex;align-items:center;justify-content:center;font-weight:bold;color:#4a7c28;box-shadow:0 2px 8px rgba(0,0,0,0.30);">3</div>
        <div style="background:white;border:2px solid #4a7c28;border-radius:5px;padding:5px;margin-top:5px;text-align:center;font-size:12px;font-weight:bold;color:#2d5016;box-shadow:0 2px 8px rgba(0,0,0,0.30);">
          <span id="overlay-level-3">-- ft</span>
        </div>
      </div>

      <!-- Shared Chat (overlaps map, lower-right) -->
      <div class="chat-widget" id="chatWidget" aria-label="Emergency coordination chat">
        <div class="chat-header">
          <div>üó®Ô∏è Ops Chat <small id="chatConn">‚Ä¢ offline</small></div>
          <small id="chatRoomLabel">waterlevel/chat</small>
        </div>
        <div class="chat-feed" id="chatFeed">
          <div class="chat-msg">
            <div class="meta"><span class="who">System</span> <span class="kind">INFO</span></div>
            <div class="body">Chat loads when MQTT connects. Use this for coordination, status updates, and action logs.</div>
          </div>
        </div>
        <div class="chat-compose">
          <input id="chatName" type="text" placeholder="Your name (e.g., Unit 12)" />
          <select id="chatKind" aria-label="Message type">
            <option value="COORD">Coordination</option>
            <option value="STATUS">Status</option>
            <option value="ACTION">Action Log</option>
          </select>
          <div class="row2">
            <input id="chatText" type="text" placeholder="Type a message‚Ä¶" maxlength="280" />
            <button id="chatSendBtn" onclick="sendChatMessage()" disabled>Send</button>
          </div>
        </div>
        <div class="chat-hint">Everyone connected to the same broker & chat topic sees the same feed (MQTT retained history).</div>
      </div>
    </div>

    <div style="margin-top:15px;padding:15px;background:#f0f9f0;border-radius:8px;">
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;">
        <div style="text-align:center;padding:10px;background:white;border-radius:8px;border:2px solid #4a7c28;">
          <div style="color:#4a7c28;font-weight:bold;margin-bottom:5px;">üåä Sensor 1 (North)</div>
          <div style="color:#666;font-size:11px;">35.2214¬∞N, 120.5138¬∞W</div>
          <div style="color:#2d5016;font-size:24px;font-weight:bold;margin-top:5px;" id="map-level-1">-- ft</div>
          <div style="color:#888;font-size:12px;" id="map-cpu-1">CPU: --¬∞C</div>
        </div>
        <div style="text-align:center;padding:10px;background:white;border-radius:8px;border:2px solid #4a7c28;">
          <div style="color:#4a7c28;font-weight:bold;margin-bottom:5px;">üåä Sensor 2 (Central)</div>
          <div style="color:#666;font-size:11px;">35.1917¬∞N, 120.5119¬∞W</div>
          <div style="color:#2d5016;font-size:24px;font-weight:bold;margin-top:5px;" id="map-level-2">-- ft</div>
          <div style="color:#888;font-size:12px;" id="map-cpu-2">CPU: --¬∞C</div>
        </div>
        <div style="text-align:center;padding:10px;background:white;border-radius:8px;border:2px solid #4a7c28;">
          <div style="color:#4a7c28;font-weight:bold;margin-bottom:5px;">üåä Sensor 3 (South)</div>
          <div style="color:#666;font-size:11px;">35.1800¬∞N, 120.5100¬∞W</div>
          <div style="color:#2d5016;font-size:24px;font-weight:bold;margin-top:5px;" id="map-level-3">-- ft</div>
          <div style="color:#888;font-size:12px;" id="map-cpu-3">CPU: --¬∞C</div>
        </div>
      </div>
    </div>
  </div>

  <div class="message-log">
    <h3>Message Log</h3>
    <div id="messageLog"><div class="log-entry">Waiting for MQTT library to load...</div></div>
  </div>

  <div class="footer-info">
    Last Update: <span id="lastUpdate">Never</span> | Total Readings: <span id="totalReadings">0</span>
  </div>
</div>

<!-- MQTT Library -->
<script src="https://unpkg.com/mqtt@4.3.7/dist/mqtt.min.js"></script>

<script>
// ========= Global State =========
let client = null;
let mqttAvailable = false;
let autoConnectTriggered = false;

let sensor1Data = { history: [], min: null, max: null };
let sensor2Data = { history: [], min: null, max: null };
let sensor3Data = { history: [], min: null, max: null };

let maxDataPoints = 100;
const MAX_TANK_HEIGHT = 10; // feet

// Chat
let chatMsgTopic = null;
let chatHistoryTopic = null;
let chatHistory = [];
const CHAT_HISTORY_LIMIT = 60;

function isHttps(){ return window.location.protocol === 'https:'; }

function sanitizeText(s){
  return (s || '').toString().replace(/[\u0000-\u001f]/g,'').trim();
}
function escapeHtml(str){
  return (str || '').toString()
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'",'&#39;');
}

// ========= Message log =========
function addLog(message){
  const log = document.getElementById('messageLog');
  const entry = document.createElement('div');
  entry.className = 'log-entry';
  entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
  log.insertBefore(entry, log.firstChild);
  while (log.children.length > 40) log.removeChild(log.lastChild);
}
function showError(message){
  const errorDiv = document.getElementById('errorNotice');
  if (!errorDiv) return;
  errorDiv.textContent = '‚ö†Ô∏è ' + message;
  errorDiv.style.display = 'block';
  setTimeout(() => { errorDiv.style.display = 'none'; }, 10000);
  console.error(message);
}

// ========= Sensor routing helpers (shortName-aware mapping + Meshtastic-style log lines) =========
const SENSOR_MAP_KEY = 'wlm_sensor_map_v2';

/**
 * Goal: route each incoming Meshtastic message into the correct dashboard slot.
 *
 * Preferred mapping (what you asked for):
 *   - Sensor shortName "0001" -> Slot 1 (North / top)
 *   - Sensor shortName "0002" -> Slot 2 (Central / middle)
 *   - Sensor shortName "0003" -> Slot 3 (South / bottom)
 *
 * We try to extract a Meshtastic shortName from the JSON payload (common fields),
 * and if found we route deterministically.
 *
 * Fallback: if no shortName is present, we keep a stable mapping based on the numeric `from`
 * value (sorted), persisted in localStorage so refreshes keep the same routing.
 */
function loadSensorMap(){
  try{
    const raw = localStorage.getItem(SENSOR_MAP_KEY);
    if (!raw) return { nodes: [] };
    const obj = JSON.parse(raw);
    if (obj && Array.isArray(obj.nodes)) return obj;
  }catch(e){}
  return { nodes: [] };
}
function saveSensorMap(map){
  try{ localStorage.setItem(SENSOR_MAP_KEY, JSON.stringify(map)); }catch(e){}
}
function pad4(n){
  const s = String(n ?? '').trim();
  if (!s) return '';
  return s.padStart(4,'0');
}
function getNodeIdFromTopic(topic){
  const tp = (topic || '').toString();
  // Meshtastic JSON topics typically end with a node id, e.g. ".../json/!abcdef01"
  const parts = tp.split('/').filter(Boolean);
  return parts.length ? parts[parts.length-1] : '';
}

/**
 * Attempt to extract a Meshtastic shortName like "0003" from known JSON shapes.
 * Returns "0001".."0003" when available, otherwise null.
 */
function extractShortName(data, topic){
  const candidates = [];

  // Common/possible shapes across different Meshtastic MQTT JSON exporters
  // (we defensively check a bunch of places)
  candidates.push(data?.shortName);
  candidates.push(data?.fromShortName);
  candidates.push(data?.sender?.shortName);
  candidates.push(data?.sender?.user?.shortName);
  candidates.push(data?.fromNode?.user?.shortName);
  candidates.push(data?.fromNode?.shortName);
  candidates.push(data?.user?.shortName);
  candidates.push(data?.packet?.fromNode?.user?.shortName);
  candidates.push(data?.packet?.fromNode?.shortName);

  // Sometimes it's embedded in the topic tail (rare, but cheap to check)
  const tail = getNodeIdFromTopic(topic);
  candidates.push(tail);

  for (const c of candidates){
    const s = (c ?? '').toString().trim();
    if (!s) continue;

    // Accept exactly 4 digits OR allow "0001"/"001"/"1" and normalize.
    const m4 = s.match(/\b(\d{4})\b/);
    if (m4){
      const sn = m4[1];
      if (sn === '0001' || sn === '0002' || sn === '0003') return sn;
    }
    const m1 = s.match(/\b(\d{1,3})\b/);
    if (m1){
      const n = parseInt(m1[1], 10);
      if (n === 1 || n === 2 || n === 3) return pad4(n);
    }
  }
  return null;
}

/**
 * Returns { slot: 1..3, shortName: "0001".."0003" } for a sensor message.
 */
function routeForMessage(data, topic){
  if (!data || typeof data.from !== 'number') return { slot: null, shortName: null };

  // 1) Preferred: shortName mapping (0001->1, 0002->2, 0003->3)
  const shortName = extractShortName(data, topic);
  if (shortName === '0001' || shortName === '0002' || shortName === '0003'){
    return { slot: parseInt(shortName, 10), shortName };
  }

  // 2) Fallback: stable mapping by `from` sorted, persisted
  const from = data.from;
  const nodeId = getNodeIdFromTopic(topic);

  const map = loadSensorMap();

  if (!map.nodes.some(n => n && n.from === from)){
    map.nodes.push({ from, nodeId });
    if (map.nodes.length > 10) map.nodes = map.nodes.slice(-10);
    map.nodes.sort((a,b) => (a.from ?? 0) - (b.from ?? 0));
    saveSensorMap(map);
    addLog(`Discovered node ${from}${nodeId ? ` (${nodeId})` : ''} ‚Äî routing recalculated`);
  } else {
    const idx = map.nodes.findIndex(n => n && n.from === from);
    if (idx >= 0 && nodeId && map.nodes[idx].nodeId !== nodeId){
      map.nodes[idx].nodeId = nodeId;
      saveSensorMap(map);
    }
  }

  const sorted = loadSensorMap().nodes
    .slice()
    .sort((a,b) => (a.from ?? 0) - (b.from ?? 0));

  const pos = sorted.findIndex(n => n && n.from === from);
  const slot = (pos >= 0) ? (pos + 1) : null;
  if (slot && slot <= 3) return { slot, shortName: pad4(slot) };
  return { slot: null, shortName: null };
}

function formatMeshtasticLine(shortName, text){
  const t = (text || '').toString().trim();
  if (!t) return '';
  const tag = (shortName || '').toString().trim();
  if (tag && !t.startsWith(tag)) return `${tag} ${t}`;
  return t;
}

// ========= Chat helpers =========
function loadChatPrefs(){
  const savedName = localStorage.getItem('wlm_chat_name') || '';
  if (savedName) document.getElementById('chatName').value = savedName;
}
function saveChatName(){
  localStorage.setItem('wlm_chat_name', sanitizeText(document.getElementById('chatName').value));
}
function setChatConnectionLabel(isOnline){
  const el = document.getElementById('chatConn');
  if (!el) return;
  el.textContent = isOnline ? '‚Ä¢ online' : '‚Ä¢ offline';
}
function setChatRoomLabel(base){
  const label = document.getElementById('chatRoomLabel');
  if (label) label.textContent = base;
}
function ensureChatTopics(){
  const base = sanitizeText(document.getElementById('chatTopic').value) || 'waterlevel/chat';
  chatMsgTopic = `${base}/msg`;
  chatHistoryTopic = `${base}/history`;
  setChatRoomLabel(base);
  return base;
}
function mergeChatMessage(msg){
  if (!msg || !msg.ts || !msg.text) return false;
  const key = `${msg.ts}|${msg.user||''}|${msg.kind||''}|${msg.text||''}`;
  if (!mergeChatMessage._seen) mergeChatMessage._seen = new Set();
  if (mergeChatMessage._seen.has(key)) return false;
  mergeChatMessage._seen.add(key);

  chatHistory.push({
    ts: msg.ts,
    user: (msg.user || '').toString().slice(0, 32),
    kind: (msg.kind || '').toString().slice(0, 12),
    text: (msg.text || '').toString().slice(0, 280),
  });
  if (chatHistory.length > CHAT_HISTORY_LIMIT) chatHistory = chatHistory.slice(-CHAT_HISTORY_LIMIT);
  return true;
}
function renderChat(){
  const feed = document.getElementById('chatFeed');
  feed.innerHTML = '';
  const items = (chatHistory || []).slice(-CHAT_HISTORY_LIMIT);
  if (!items.length){
    feed.innerHTML = '<div class="chat-msg"><div class="meta"><span class="who">System</span> <span class="kind">INFO</span></div><div class="body">No messages yet.</div></div>';
    return;
  }
  for (const m of items){
    const div = document.createElement('div');
    div.className = 'chat-msg';
    const when = m.ts ? new Date(m.ts).toLocaleTimeString() : '';
    div.innerHTML = `
      <div class="meta">
        <span class="who">${escapeHtml(m.user || 'Unknown')}</span>
        <span class="kind">${escapeHtml(m.kind || 'MSG')}</span>
        <span class="when">${escapeHtml(when)}</span>
      </div>
      <div class="body">${escapeHtml(m.text || '')}</div>
    `;
    feed.appendChild(div);
  }
  feed.scrollTop = feed.scrollHeight;
}
function publishChatHistoryRetained(){
  if (!client || !chatHistoryTopic) return;
  try{
    const payload = JSON.stringify({ v: 1, items: chatHistory.slice(-CHAT_HISTORY_LIMIT) });
    client.publish(chatHistoryTopic, payload, { retain: true, qos: 0 });
  } catch(e){}
}
function sendChatMessage(){
  if (!client || !chatMsgTopic) return;
  const user = sanitizeText(document.getElementById('chatName').value) || 'Unknown';
  const kind = sanitizeText(document.getElementById('chatKind').value) || 'COORD';
  const textEl = document.getElementById('chatText');
  const text = sanitizeText(textEl.value);
  if (!text) return;

  saveChatName();
  const msg = { ts: Date.now(), user, kind, text };

  try{ client.publish(chatMsgTopic, JSON.stringify(msg), { qos: 0 }); } catch(e){}

  if (mergeChatMessage(msg)){
    renderChat();
    publishChatHistoryRetained();
  }
  textEl.value = '';
}

// Enter-to-send
document.addEventListener('keydown', (e) => {
  const active = document.activeElement;
  if (e.key === 'Enter' && active && active.id === 'chatText') {
    e.preventDefault();
    sendChatMessage();
  }
});

// ========= MQTT Presets =========
function setPreset(preset){
  const configs = {
    emqx: { broker:'broker.emqx.io', port:'8084', topic:'msh/US/2/json/#' },
    hivemq: { broker:'broker.hivemq.com', port:'8884', topic:'meshtastic/#' },
    mosquitto: { broker:'test.mosquitto.org', port:'8081', topic:'meshtastic/#' },
  };
  const c = configs[preset];
  if (!c) return;
  document.getElementById('broker').value = c.broker;
  document.getElementById('port').value = c.port;
  document.getElementById('topic').value = c.topic;
  addLog(`Preset selected: ${preset}`);
  // Reconnect if currently connected
  if (client) {
    disconnectMQTT();
    setTimeout(connectMQTT, 250);
  }
}

// ========= MQTT Connect/Disconnect =========
function connectMQTT(){
  if (typeof mqtt === 'undefined'){
    alert('MQTT library not loaded. Please refresh.');
    return;
  }

  const broker = sanitizeText(document.getElementById('broker').value);
  const port = sanitizeText(document.getElementById('port').value);
  const topic = sanitizeText(document.getElementById('topic').value);
  maxDataPoints = parseInt(document.getElementById('maxPoints').value, 10) || 100;

  if (!broker || !port) { alert('Please enter broker and port'); return; }

  // Clean up existing client
  if (client) {
    try{ client.end(true); } catch(e){}
    client = null;
  }

  document.getElementById('status').className = 'status connecting';
  document.getElementById('status').textContent = 'Connecting...';

  // We default to WSS; if you're running on http:// and want WS, you can set a ws port.
  const protocol = isHttps() ? 'wss' : 'wss';
  const url = `${protocol}://${broker}:${port}/mqtt`;

  addLog(`Connecting to ${url} (${protocol.toUpperCase()})`);
  client = mqtt.connect(url, {
    clientId: 'water-' + Math.random().toString(16).slice(2, 10),
    clean: true,
    connectTimeout: 10000,
    reconnectPeriod: 5000,
  });

  client.on('connect', () => {
    document.getElementById('status').className = 'status connected';
    document.getElementById('status').textContent = `Connected to ${broker}:${port}`;
    document.getElementById('connectBtn').style.display = 'none';
    document.getElementById('disconnectBtn').style.display = 'inline-block';

    // Sensor topic
    client.subscribe(topic, (err) => {
      if (err) {
        showError('Subscribe failed: ' + err.message);
        addLog('Subscribe error: ' + err.message);
        return;
      }
      addLog(`Subscribed to: ${topic}`);
    });

    // Chat topics
    ensureChatTopics();
    client.subscribe([chatMsgTopic, chatHistoryTopic], (err) => {
      if (!err) {
        setChatConnectionLabel(true);
        document.getElementById('chatSendBtn').disabled = false;
        addLog(`Chat subscribed: ${chatMsgTopic} + ${chatHistoryTopic}`);
      }
    });

    // Request retained history to render quickly
    // (We rely on retained history topic; broker will deliver current retained payload automatically.)
  });

  client.on('message', (topic, payload) => {
    // Chat retained history
    if (chatHistoryTopic && topic === chatHistoryTopic){
      try{
        const obj = JSON.parse(payload.toString());
        if (obj && Array.isArray(obj.items)){
          for (const m of obj.items) mergeChatMessage(m);
          renderChat();
        }
      } catch(e){}
      return;
    }

    // Chat messages
    if (chatMsgTopic && topic === chatMsgTopic){
      try{
        const msg = JSON.parse(payload.toString());
        if (mergeChatMessage(msg)){
          renderChat();
          publishChatHistoryRetained();
        }
      } catch(e){}
      return;
    }

    // Sensor messages (Meshtastic JSON feed)
    handleSensorMessage(topic, payload);
  });

  client.on('error', (err) => {
    document.getElementById('status').className = 'status disconnected';
    document.getElementById('status').textContent = 'Connection Error';
    document.getElementById('connectBtn').style.display = 'inline-block';
    document.getElementById('disconnectBtn').style.display = 'none';
    addLog('Error: ' + (err?.message || err));
    showError(err?.message || String(err));
    setChatConnectionLabel(false);
    document.getElementById('chatSendBtn').disabled = true;
  });

  client.on('offline', () => {
    document.getElementById('status').className = 'status disconnected';
    document.getElementById('status').textContent = 'Offline';
    setChatConnectionLabel(false);
    document.getElementById('chatSendBtn').disabled = true;
  });
}

function disconnectMQTT(){
  if (!client) return;
  try{ client.end(true); } catch(e){}
  client = null;
  document.getElementById('status').className = 'status disconnected';
  document.getElementById('status').textContent = 'Disconnected';
  document.getElementById('connectBtn').style.display = 'inline-block';
  document.getElementById('disconnectBtn').style.display = 'none';
  addLog('Disconnected');
  setChatConnectionLabel(false);
  document.getElementById('chatSendBtn').disabled = true;
}

// ========= Sensor parsing + UI updates =========
function extractLevelAndCpu(text){
  const t = (text || '').toString();
  const levelMatch = t.match(/([\d.]+)\s*feet/i) || t.match(/([\d.]+)\s*ft\b/i) || t.match(/Level:\s*([\d.]+)/i);
  const cpuMatch = t.match(/CPU:\s*([\d.]+)\s*¬∞?C/i);
  const level = levelMatch ? parseFloat(levelMatch[1]) : null;
  const cpu = cpuMatch ? parseFloat(cpuMatch[1]) : null;
  return { level, cpu };
}

function handleSensorMessage(topic, payload){
  let data = null;
  const raw = payload.toString();

  try{ data = JSON.parse(raw); } catch(e){ /* not JSON */ }

  // Expect Meshtastic JSON: { type:"text", from:<number>, payload:{ text:"..." } }
  if (!data || data.type !== 'text' || !data.payload || typeof data.payload.text !== 'string') return;

  const text = data.payload.text;
  const { level, cpu } = extractLevelAndCpu(text);

  // Determine which dashboard slot should receive this node's data
  const route = routeForMessage(data, topic); // { slot: 1..3|null, shortName: "0001".."0003"|null }
  const slot = route.slot;
  const shortName = route.shortName;
  const nodeId = getNodeIdFromTopic(topic);

  // Message Log formatting: keep Topic line, then Message line prefixed with sensor shortName (Meshtastic-style)
  addLog(`Topic: ${topic}`);
  addLog(`Message: ${formatMeshtasticLine(shortName, text)}`);

  if (level == null) return;
  if (!slot) return; // ignore extra nodes beyond the 3 dashboard slots

  updateSensor(slot, level, cpu, (shortName || nodeId));
}

function updateSensor(num, level, cpu, nodeId){
  const timestamp = new Date();
  const sensorData = (num === 1) ? sensor1Data : (num === 2 ? sensor2Data : sensor3Data);

  const displayValue = Math.max(0, level);

  document.getElementById(`level${num}`).textContent = `${displayValue.toFixed(1)} ft`;
  document.getElementById(`stat${num}`).textContent  = `${displayValue.toFixed(1)} ft`;
  if (nodeId) document.getElementById(`node${num}`).textContent = nodeId.substring(0, 10);
  if (cpu !== null && cpu !== undefined) document.getElementById(`cpu${num}`).textContent = `${cpu.toFixed(0)}¬∞C`;

  if (sensorData.min === null || displayValue < sensorData.min) sensorData.min = displayValue;
  if (sensorData.max === null || displayValue > sensorData.max) sensorData.max = displayValue;

  document.getElementById(`minmax${num}`).textContent = `${sensorData.min?.toFixed(1) ?? '--'} / ${sensorData.max?.toFixed(1) ?? '--'}`;

  const percent = Math.min(100, Math.max(0, (displayValue / MAX_TANK_HEIGHT) * 100));
  document.getElementById(`tank${num}`).style.height = `${percent}%`;

  sensorData.history.push({ time: timestamp, level: displayValue, cpu: cpu });
  if (sensorData.history.length > maxDataPoints) sensorData.history.shift();

  updateHistoryTable();

  const mapLevel = document.getElementById(`map-level-${num}`);
  if (mapLevel) mapLevel.textContent = `${displayValue.toFixed(1)} ft`;
  const overlayLevel = document.getElementById(`overlay-level-${num}`);
  if (overlayLevel) overlayLevel.textContent = `${displayValue.toFixed(1)} ft`;

  const mapCpu = document.getElementById(`map-cpu-${num}`);
  if (mapCpu && cpu !== null && cpu !== undefined) mapCpu.textContent = `CPU: ${cpu.toFixed(0)}¬∞C`;

  document.getElementById('lastUpdate').textContent = timestamp.toLocaleTimeString();
  document.getElementById('totalReadings').textContent =
    (sensor1Data.history.length + sensor2Data.history.length + sensor3Data.history.length).toString();
}

function updateHistoryTable(){
  const tbody = document.getElementById('historyTableBody');

  const combined = [
    ...sensor1Data.history.map(d => ({ t:d.time, s:1, level:d.level })),
    ...sensor2Data.history.map(d => ({ t:d.time, s:2, level:d.level })),
    ...sensor3Data.history.map(d => ({ t:d.time, s:3, level:d.level })),
  ];

  const bySec = new Map();
  for (const d of combined){
    if (!d || !d.t) continue;
    const key = Math.floor(new Date(d.t).getTime() / 1000);
    if (!bySec.has(key)) bySec.set(key, { t:new Date(key*1000), s1:null, s2:null, s3:null });
    const row = bySec.get(key);
    if (d.s === 1 && row.s1 == null) row.s1 = d.level;
    if (d.s === 2 && row.s2 == null) row.s2 = d.level;
    if (d.s === 3 && row.s3 == null) row.s3 = d.level;
  }

  const rowsArr = Array.from(bySec.values()).sort((a,b) => b.t - a.t).slice(0, 20);
  const rows = rowsArr.map(r => `
    <tr>
      <td>${r.t.toLocaleTimeString()}</td>
      <td>${(r.s1 != null) ? r.s1.toFixed(1) : ''}</td>
      <td>${(r.s2 != null) ? r.s2.toFixed(1) : ''}</td>
      <td>${(r.s3 != null) ? r.s3.toFixed(1) : ''}</td>
    </tr>
  `).join('');

  tbody.innerHTML = rows || '<tr><td colspan="4" style="text-align:center;">No data yet</td></tr>';
}

// ========= Export / Clear =========
function exportData(){
  try{
    const combined = [
      ...sensor1Data.history.map(d => ({ t:d.time, s:1, level:d.level })),
      ...sensor2Data.history.map(d => ({ t:d.time, s:2, level:d.level })),
      ...sensor3Data.history.map(d => ({ t:d.time, s:3, level:d.level })),
    ];
    const bySec = new Map();
    for (const d of combined){
      if (!d || !d.t) continue;
      const key = Math.floor(new Date(d.t).getTime() / 1000);
      if (!bySec.has(key)) bySec.set(key, { t:new Date(key*1000), s1:null, s2:null, s3:null });
      const row = bySec.get(key);
      if (d.s === 1 && row.s1 == null) row.s1 = d.level;
      if (d.s === 2 && row.s2 == null) row.s2 = d.level;
      if (d.s === 3 && row.s3 == null) row.s3 = d.level;
    }
    const rowsArr = Array.from(bySec.values()).sort((a,b) => a.t - b.t);

    let csv = 'Timestamp,Sensor 1 (ft),Sensor 2 (ft),Sensor 3 (ft)\n';
    for (const r of rowsArr){
      const s1 = (r.s1 != null) ? r.s1.toFixed(2) : '';
      const s2 = (r.s2 != null) ? r.s2.toFixed(2) : '';
      const s3 = (r.s3 != null) ? r.s3.toFixed(2) : '';
      csv += `${r.t.toISOString()},${s1},${s2},${s3}\n`;
    }

    const blob = new Blob([csv], { type:'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `water-levels-3sensors-${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    addLog('Data exported to CSV');
  } catch(e){
    showError('Export failed: ' + e.message);
  }
}

function clearData(){
  if (!confirm('Clear all data? This cannot be undone.')) return;
  sensor1Data = { history: [], min: null, max: null };
  sensor2Data = { history: [], min: null, max: null };
  sensor3Data = { history: [], min: null, max: null };
  updateHistoryTable();
  document.getElementById('minmax1').textContent = '-- / --';
  document.getElementById('minmax2').textContent = '-- / --';
  document.getElementById('minmax3').textContent = '-- / --';
  try{ localStorage.removeItem(SENSOR_MAP_KEY); }catch(e){}
  addLog('Data cleared (including sensor routing map)');
}

// ========= Boot =========
function checkMQTT(){
  if (typeof mqtt !== 'undefined'){
    mqttAvailable = true;
    document.getElementById('connectBtn').disabled = false;
    document.getElementById('loadingNotice').style.display = 'none';
    addLog('MQTT library loaded successfully');
    addLog('Auto-connecting to EMQX Public...');
    if (!autoConnectTriggered){
      autoConnectTriggered = true;
      setTimeout(connectMQTT, 600);
    }
  } else {
    showError('Unable to load MQTT library.');
  }
}

window.addEventListener('load', () => {
  loadChatPrefs();
  // Save name on blur
  document.getElementById('chatName').addEventListener('blur', saveChatName);
  checkMQTT();
});
</script>
</body>
</html>
